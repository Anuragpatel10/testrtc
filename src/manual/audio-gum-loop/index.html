<!DOCTYPE html>
<!--
  Copyright (c) 2014 The WebRTC project authors. All Rights Reserved.

  Use of this source code is governed by a BSD-style license
  that can be found in the LICENSE file in the root of the source
  tree. An additional intellectual property rights grant can be found
  in the file PATENTS.  All contributing project authors may
  be found in the AUTHORS file in the root of the source tree.
-->
<html>
<head>
  <title>Audio only getUserMedia loop</title>
  <meta http-equiv="X-UA-Compatible" content="chrome=1"/>
  <!-- Load the polyfill to switch-hit between Chrome and Firefox -->
  <script src="adapter.js"></script>

</head>
<body onload="startGetUserMediaSequence();">
  Audio getUserMedia loop that starts on page load
  <table border="0">
    <tr>
      <td><audio id="audio1" autoplay="autoplay"></audio></td>
      <td><button id="start" disabled>Start getUserMedia loop</button></td>
      <td><button id="stop">Stop getUserMedia loop</button></td>
      <td><input id="timer" value="3000">Time in MS between loops</input></td>
    </tr>
  </table>
  Logging:
  <div id="log"></div>
  <script type="text/javascript">

  var audioElement = document.querySelector('#audio1');
  var startButton = document.querySelector('#start');
  var stopButton = document.querySelector('#stop');
  var timer = document.querySelector('#timer');
  var log = document.querySelector('#log');
  var localStream = null;
  var getUserMediaLoop = null;
  var wait = null;
  var runCounter = -1;

  startButton.addEventListener('click', startGetUserMediaSequence);

  stopButton.addEventListener('click', function() {
    stopButton.disabled = (stopButton.disabled ? false : true);
    startButton.disabled = false;
  });

  timer.addEventListener('Ã§hange'), function() {
    timer.value = timer.value;
  }

  function logging(message) {
    log.innerHTML += '<span>Run number: ' + runCounter + ' - '+  message +
        '</span><br>';
    console.log(message);
  }

  function startGetUserMediaSequence() {
    runCounter++
    logging('Loop started');
    startButton.disabled = true;
    stopButton.disabled = false;
    getUserMediaLoop = setTimeout(callGetUserMedia, timer.value);
  }

  function clearLocalStreams() {
    if (localStream) {
      logging('Tracks stopped');
      localStream.getTracks().forEach(function(track) {
        track.stop();
      })
      localStream = null;
    }
  }

function continueLoop(stream) {
  if (!stopButton.disabled) {
    audioElement.srcObject = localStream;
    startGetUserMediaSequence();
  } else {
    stop();
  }
}

function stop() {
  logging('Loop stopped');
  clearLocalStreams();
  clearTimeout(startGetUserMediaSequence);
  clearTimeout(wait);
}

  function callGetUserMedia() {
    if (!stopButton.disabled) {
      navigator.mediaDevices.getUserMedia({video: false, audio: true})
      .then(function(stream) {
        var time = Date.now();
        if (localStream) {
          clearLocalStreams();

          wait = setTimeout(function() {
            localStream = stream;
            continueLoop();
          }.bind(stream), timer.value);
        } else {
          localStream = stream;
          continueLoop();
        }
      })
      .catch(function(error) {
        if (localStream) {
          clearLocalStreams();
        }
        alert('getUserMedia failed: ' + error);
      })
    } else {
      stop();
    }
  }
  </script>
</body>

</html>
